<!DOCTYPE html>
<html>
<head>
    <title>cube relay</title>
    <script type="importmap">
    {
        "imports": {
            "rxjs": "https://cdn.skypack.dev/rxjs@7",
            "aes-js": "https://cdn.skypack.dev/aes-js@3"
        }
    }
    </script>
    <style>
        body { font-family: monospace; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; border: 1px solid #c3e6cb; }
        .disconnected { background: #f8d7da; border: 1px solid #f5c6cb; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; height: 300px; overflow-y: scroll; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>cube relay</h1>
    
    <div id="status" class="status disconnected">
        status: disconnected 
    </div>
    
    <button id="connectWS">connect to wsl</button>
    <button id="connectCube">connect cube</button>
    <button id="disconnect">disconnect</button>
    
    <h3>move events:</h3>
    <div id="log" class="log"></div>
    
    <h3>gyro events:</h3>
    <div id="gyroLog" class="log"></div>

    <script type="module">
        // Import GAN cube functionality
        import { connectGanCube } from './dist/esm/index.mjs';
        
        let websocket = null;
        let ganCubeConnection = null;
        let lastGyroTime = 0;
        
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        const gyroLogDiv = document.getElementById('gyroLog');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function logGyro(message) {
            const timestamp = new Date().toLocaleTimeString();
            gyroLogDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            gyroLogDiv.scrollTop = gyroLogDiv.scrollHeight;
        }
        
        function updateStatus(message, connected = false) {
            statusDiv.textContent = `Status: ${message}`;
            statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }
        
        // WebSocket connection to WSL Node.js server
        function connectWebSocket() {
            try {
                websocket = new WebSocket('ws://localhost:8080');
                
                websocket.onopen = () => {
                    log('connected to wsl websocket server');
                    updateStatus('websocket connected', true);
                };
                
                websocket.onclose = () => {
                    log('websocket connection closed');
                    updateStatus('websocket disconnected', false);
                };
                
                websocket.onerror = (error) => {
                    log(`websocket error: ${error}`);
                };
                
            } catch (error) {
                log(`failed to connect WebSocket: ${error}`);
            }
        }
        
        // Send data to WSL via WebSocket
        function sendToWSL(data) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify(data));
                return true;
            }
            return false;
        }
        
        // Connect to GAN cube and relay events
        async function connectCube() {
            if (ganCubeConnection) {
                log('cube already connected!');
                return;
            }
            
            try {
                log('connecting to cube...');
                
                // Custom MAC address provider for browser compatibility
                const customMacAddressProvider = async (device, isFallbackCall) => {
                    if (isFallbackCall) {
                        return prompt('Unable to determine cube MAC address!\nPlease enter MAC address manually:');
                    } else {
                        return typeof device.watchAdvertisements == 'function' ? null :
                            prompt('Browser does not support Web Bluetooth watchAdvertisements() API.\nEnable chrome://flags/#enable-experimental-web-platform-features\n\nOr enter cube MAC address manually:');
                    }
                };
                
                ganCubeConnection = await connectGanCube(customMacAddressProvider);
                
                log(`connected to cube: ${ganCubeConnection.deviceName} (${ganCubeConnection.deviceMAC})`);
                
                // Subscribe to cube events
                ganCubeConnection.events$.subscribe(event => {
                    handleCubeEvent(event);
                });
                
                // Request initial cube info
                await ganCubeConnection.sendCubeCommand({ type: "REQUEST_HARDWARE" });
                await ganCubeConnection.sendCubeCommand({ type: "REQUEST_FACELETS" });
                await ganCubeConnection.sendCubeCommand({ type: "REQUEST_BATTERY" });
                
                log('cube ready.');
                
            } catch (error) {
                log(`failed to connect to cube: ${error.message}`);
                ganCubeConnection = null;
            }
        }
        
        // Handle cube events and relay to WSL
        function handleCubeEvent(event) {
            console.log('cube event:', event);
            
            // Relay event to WSL if connected
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const relayEvent = {
                    type: event.type,
                    timestamp: Date.now(),
                    cubeTimestamp: event.cubeTimestamp,
                    ...event
                };
                
                if (event.type === 'MOVE') {
                    log(`cube move: ${event.move}`);
                    sendToWSL(relayEvent);
                } else if (event.type === 'GYRO') {
                    // Throttle gyro events - only log every 10ms
                    const now = Date.now();
                    if (now - lastGyroTime > 10) {
                        const { x, y, z, w } = event.quaternion;
                        let gyroMsg = `quaternion: x=${x.toFixed(3)}, y=${y.toFixed(3)}, z=${z.toFixed(3)}, w=${w.toFixed(3)}`;
                        
                        if (event.velocity) {
                            const { x: vx, y: vy, z: vz } = event.velocity;
                            gyroMsg += ` | Velocity: x=${vx}, y=${vy}, z=${vz}`;
                        }
                        
                        logGyro(gyroMsg);
                        lastGyroTime = now;
                    }
                    sendToWSL(relayEvent);
                } else if (event.type === 'BATTERY') {
                    log(`battery: ${event.batteryLevel}%`);
                    sendToWSL(relayEvent);
                } else if (event.type === 'HARDWARE') {
                    log(`hardware: ${event.hardwareName} v${event.hardwareVersion}`);
                    sendToWSL(relayEvent);
                } else if (event.type === 'FACELETS') {
                    log(`cube state updated`);
                    sendToWSL(relayEvent);
                } else {
                    log(`event: ${event.type}`);
                    sendToWSL(relayEvent);
                }
            } else {
                if (event.type !== 'GYRO') { // Don't spam with gyro errors
                    log(`cannot relay ${event.type} - WSL not connected`);
                }
            }
        }
        
        function disconnect() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            if (ganCubeConnection) {
                ganCubeConnection.disconnect();
                ganCubeConnection = null;
                log('cube disconnected');
            }
            
            log('disconnected');
            updateStatus('disconnected', false);
        }
        
        // Event listeners
        document.getElementById('connectWS').addEventListener('click', connectWebSocket);
        document.getElementById('connectCube').addEventListener('click', connectCube);
        document.getElementById('disconnect').addEventListener('click', disconnect);
        
        log('connect to wsl, then connect cube');
    </script>
</body>
</html>

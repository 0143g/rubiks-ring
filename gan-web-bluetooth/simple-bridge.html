<!DOCTYPE html>
<html>
<head>
    <title>GAN Cube ‚Üí WSL Bridge (Simple)</title>
    <script type="importmap">
    {
        "imports": {
            "rxjs": "https://cdn.skypack.dev/rxjs@7",
            "aes-js": "https://cdn.skypack.dev/aes-js@3"
        }
    }
    </script>
    <style>
        body { font-family: monospace; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; border: 1px solid #c3e6cb; }
        .disconnected { background: #f8d7da; border: 1px solid #f5c6cb; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; height: 300px; overflow-y: scroll; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>GAN Cube ‚Üí WSL Bridge (Simple Test)</h1>
    
    <div id="status" class="status disconnected">
        Status: Disconnected
    </div>
    
    <button id="connectWS">Connect to WSL (ws://localhost:8080)</button>
    <button id="connectCube">Connect GAN Cube</button>
    <button id="disconnect">Disconnect</button>
    
    <h3>Event Log:</h3>
    <div id="log" class="log"></div>

    <script type="module">
        // Import GAN cube functionality
        import { connectGanCube } from './dist/esm/index.mjs';
        
        let websocket = null;
        let ganCubeConnection = null;
        
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, connected = false) {
            statusDiv.textContent = `Status: ${message}`;
            statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }
        
        // WebSocket connection to WSL Node.js server
        function connectWebSocket() {
            try {
                websocket = new WebSocket('ws://localhost:8080');
                
                websocket.onopen = () => {
                    log('Connected to WSL WebSocket server');
                    updateStatus('WebSocket Connected', true);
                };
                
                websocket.onclose = () => {
                    log('WebSocket connection closed');
                    updateStatus('WebSocket Disconnected', false);
                };
                
                websocket.onerror = (error) => {
                    log(`WebSocket error: ${error}`);
                };
                
            } catch (error) {
                log(`Failed to connect WebSocket: ${error}`);
            }
        }
        
        // Send data to WSL via WebSocket
        function sendToWSL(data) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify(data));
                return true;
            }
            return false;
        }
        
        // Connect to GAN cube and relay events
        async function connectCube() {
            if (ganCubeConnection) {
                log('‚ùå Cube already connected!');
                return;
            }
            
            try {
                log('üîó Connecting to GAN cube...');
                
                // Custom MAC address provider for browser compatibility
                const customMacAddressProvider = async (device, isFallbackCall) => {
                    if (isFallbackCall) {
                        return prompt('Unable to determine cube MAC address!\nPlease enter MAC address manually:');
                    } else {
                        return typeof device.watchAdvertisements == 'function' ? null :
                            prompt('Browser does not support Web Bluetooth watchAdvertisements() API.\nEnable chrome://flags/#enable-experimental-web-platform-features\n\nOr enter cube MAC address manually:');
                    }
                };
                
                ganCubeConnection = await connectGanCube(customMacAddressProvider);
                
                log(`‚úÖ Connected to cube: ${ganCubeConnection.deviceName} (${ganCubeConnection.deviceMAC})`);
                
                // Subscribe to cube events
                ganCubeConnection.events$.subscribe(event => {
                    handleCubeEvent(event);
                });
                
                // Request initial cube info
                await ganCubeConnection.sendCubeCommand({ type: "REQUEST_HARDWARE" });
                await ganCubeConnection.sendCubeCommand({ type: "REQUEST_FACELETS" });
                await ganCubeConnection.sendCubeCommand({ type: "REQUEST_BATTERY" });
                
                log('üéØ Cube ready! Make moves to send events to WSL.');
                
            } catch (error) {
                log(`‚ùå Failed to connect to cube: ${error.message}`);
                ganCubeConnection = null;
            }
        }
        
        // Handle cube events and relay to WSL
        function handleCubeEvent(event) {
            console.log('GAN Cube Event:', event);
            
            // Relay event to WSL if connected
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const relayEvent = {
                    type: event.type,
                    timestamp: Date.now(),
                    cubeTimestamp: event.cubeTimestamp,
                    ...event
                };
                
                if (event.type === 'MOVE') {
                    log(`üì§ Cube move: ${event.move}`);
                } else if (event.type === 'BATTERY') {
                    log(`üîã Battery: ${event.batteryLevel}%`);
                } else if (event.type === 'HARDWARE') {
                    log(`üîß Hardware: ${event.hardwareName} v${event.hardwareVersion}`);
                } else if (event.type === 'FACELETS') {
                    log(`üé≤ Cube state updated`);
                } else {
                    log(`üì° Event: ${event.type}`);
                }
                
                sendToWSL(relayEvent);
            } else {
                log(`‚ùå Cannot relay ${event.type} - WSL not connected`);
            }
        }
        
        function disconnect() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            if (ganCubeConnection) {
                ganCubeConnection.disconnect();
                ganCubeConnection = null;
                log('üîå Cube disconnected');
            }
            
            log('Disconnected');
            updateStatus('Disconnected', false);
        }
        
        // Event listeners
        document.getElementById('connectWS').addEventListener('click', connectWebSocket);
        document.getElementById('connectCube').addEventListener('click', connectCube);
        document.getElementById('disconnect').addEventListener('click', disconnect);
        
        log('GAN Cube ‚Üí WSL Bridge loaded. Connect to WSL first, then connect your GAN cube to relay moves.');
    </script>
</body>
</html>
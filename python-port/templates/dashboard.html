<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elden Cube</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script type="module" src="https://cdn.cubing.net/v0/js/cubing/twisty"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            padding: 24px 0;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .header p {
            color: #888;
            font-size: 0.9rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 24px;
            min-height: calc(100vh - 200px);
        }

        .panel {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            overflow: hidden;
        }

        .panel-header {
            background: #1a1a1a;
            padding: 16px 20px;
            border-bottom: 1px solid #222;
            font-size: 0.85rem;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .panel-content {
            padding: 20px;
        }

        /* Left Panel - Connection & Status */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            transition: all 0.3s ease;
        }

        .status-dot.connected {
            background: #00ff88;
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.4);
        }

        .status-text {
            font-size: 0.9rem;
            color: #ccc;
        }

        .btn {
            width: 100%;
            padding: 12px 16px;
            background: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }

        .btn:hover {
            background: #444;
            border-color: #555;
        }

        .btn.primary {
            background: #007aff;
            border-color: #007aff;
        }

        .btn.primary:hover {
            background: #0056cc;
            border-color: #0056cc;
        }

        .btn.danger {
            background: #ff3b30;
            border-color: #ff3b30;
        }

        .btn.danger:hover {
            background: #cc1f14;
            border-color: #cc1f14;
        }

        .btn:disabled {
            background: #222;
            border-color: #222;
            color: #666;
            cursor: not-allowed;
        }

        /* Center Panel - Cube Visualization */
        .cube-container {
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0a0a;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .orientation-display {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 12px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.8rem;
        }

        .orientation-item {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .orientation-label {
            color: #888;
            font-size: 0.7rem;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .orientation-value {
            color: #00ff88;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Right Panel - Activity & Info */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            color: #fff;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #888;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .move-history {
            background: #0a0a0a;
            border-radius: 6px;
            padding: 16px;
            height: 300px;
            overflow-y: auto;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .move-item {
            padding: 6px 0;
            border-bottom: 1px solid #222;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .move-item:last-child {
            border-bottom: none;
        }

        .move-notation {
            color: #00ff88;
            font-weight: 600;
        }

        .move-time {
            color: #666;
            font-size: 0.7rem;
        }

        /* Controller section */
        .controller-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #222;
        }

        .controller-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #333;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #007aff;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        .toggle-label {
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Animations */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .connecting {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 0.85rem;
            border-left: 3px solid;
        }

        .message.success {
            background: rgba(0, 255, 136, 0.1);
            border-left-color: #00ff88;
            color: #00ff88;
        }

        .message.error {
            background: rgba(255, 59, 48, 0.1);
            border-left-color: #ff3b30;
            color: #ff3b30;
        }

        .message.info {
            background: rgba(0, 122, 255, 0.1);
            border-left-color: #007aff;
            color: #007aff;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: 280px 1fr 280px;
                gap: 16px;
            }
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .cube-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="grid">
            <!-- Left Panel: Connection & Controls -->
            <div class="panel">
                <div class="panel-header">Connection</div>
                <div class="panel-content">
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span class="status-text" id="statusText">Disconnected</span>
                    </div>

                    <button class="btn primary" id="connectBtn">Connect Cube</button>
                    <button class="btn danger" id="disconnectBtn" disabled>Disconnect</button>
                    <button class="btn" id="resetOrientationBtn">Reset Orientation</button>
                    <button class="btn" id="clearHistoryBtn">Clear History</button>

                    <div class="controller-section">
                        <div class="controller-toggle">
                            <div class="toggle-switch" id="controllerToggle"></div>
                            <span class="toggle-label">Controller Mode</span>
                        </div>
                        <button class="btn" id="connectControllerBtn">Connect Bridge</button>
                    </div>

                    <div id="messageArea"></div>
                </div>
            </div>

            <!-- Center Panel: Cube Visualization -->
            <div class="panel">
                <div class="panel-header">Cube Visualization</div>
                <div class="panel-content">
                    <div class="cube-container" id="cubeContainer">
                        <twisty-player 
                            id="twistyPlayer"
                            puzzle="3x3x3"
                            alg=""
                            background="none"
                            control-panel="none"
                            style="width: 100%; height: 100%;">
                        </twisty-player>
                    </div>

                    <div class="orientation-display">
                        <div class="orientation-item">
                            <div class="orientation-label">Quat X</div>
                            <div class="orientation-value" id="orientX">0.000</div>
                        </div>
                        <div class="orientation-item">
                            <div class="orientation-label">Quat Y</div>
                            <div class="orientation-value" id="orientY">0.000</div>
                        </div>
                        <div class="orientation-item">
                            <div class="orientation-label">Quat Z</div>
                            <div class="orientation-value" id="orientZ">0.000</div>
                        </div>
                        <div class="orientation-item">
                            <div class="orientation-label">Quat W</div>
                            <div class="orientation-value" id="orientW">1.000</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Stats & History -->
            <div class="panel">
                <div class="panel-header">Statistics</div>
                <div class="panel-content">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="moveCount">0</div>
                            <div class="stat-label">Total Moves</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="batteryLevel">-</div>
                            <div class="stat-label">Battery</div>
                        </div>
                    </div>

                    <div class="panel-header" style="margin: 20px -20px 16px -20px; padding: 12px 20px;">Move History</div>
                    <div class="move-history" id="moveHistory">
                        <div style="color: #666; text-align: center; padding: 20px; font-size: 0.8rem;">
                            No moves recorded yet
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        const socket = io();
        
        // UI elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const resetOrientationBtn = document.getElementById('resetOrientationBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const controllerToggle = document.getElementById('controllerToggle');
        const connectControllerBtn = document.getElementById('connectControllerBtn');
        const messageArea = document.getElementById('messageArea');
        const twistyPlayer = document.getElementById('twistyPlayer');
        const moveHistory = document.getElementById('moveHistory');
        const moveCount = document.getElementById('moveCount');
        const batteryLevel = document.getElementById('batteryLevel');
        const orientX = document.getElementById('orientX');
        const orientY = document.getElementById('orientY');
        const orientZ = document.getElementById('orientZ');
        const orientW = document.getElementById('orientW');

        // State
        let isConnected = false;
        let controllerEnabled = false;
        let totalMoves = 0;
        let basis = null;

        // Socket event handlers
        socket.on('connect', () => {
            console.log('Connected to dashboard');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from dashboard');
        });

        socket.on('status', (data) => {
            isConnected = data.connected;
            updateConnectionStatus(data.status);
            
            if (data.hardware_info && data.hardware_info.modelName) {
                statusText.textContent = `Connected - ${data.hardware_info.modelName}`;
            }
        });

        socket.on('battery', (data) => {
            batteryLevel.textContent = data.percent + '%';
        });

        socket.on('move', (data) => {
            totalMoves++;
            moveCount.textContent = totalMoves;
            addMoveToHistory(data.move, data.timestamp);
            
            // Update twisty player with the move
            if (twistyPlayer && twistyPlayer.experimentalAddMove) {
                twistyPlayer.experimentalAddMove(data.move);
            } else if (twistyPlayer) {
                const currentAlg = twistyPlayer.alg || '';
                twistyPlayer.alg = currentAlg + ' ' + data.move;
            }
        });

        socket.on('move_history', (data) => {
            totalMoves = data.total_count;
            moveCount.textContent = totalMoves;
            updateMoveHistory(data.moves);
        });

        socket.on('orientation', (data) => {
            // Update both the 3D visualization AND the text display
            if (data.quaternion) {
                updateOrientation(data.quaternion);
                updateOrientationDisplay(data.quaternion);
            }
        });

        socket.on('facelets', (data) => {
            // Update cube state visualization if available
            if (twistyPlayer && data.facelets) {
                try {
                    // Convert Kociemba facelets to twisty player format if needed
                    twistyPlayer.experimentalSetCubieCube(data.facelets);
                } catch (e) {
                    console.log('Could not set cube state:', e);
                }
            }
        });

        socket.on('message', (data) => {
            showMessage(data.text, data.type);
        });

        // UI functions
        function updateConnectionStatus(status) {
            statusDot.className = 'status-dot';
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            
            switch (status) {
                case 'connected':
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Connected';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    break;
                case 'connecting':
                    statusDot.classList.add('connecting');
                    statusText.textContent = 'Connecting...';
                    connectBtn.disabled = true;
                    break;
                default:
                    statusText.textContent = 'Disconnected';
            }
        }

        function showMessage(text, type = 'info') {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            messageArea.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 5000);
        }

        function addMoveToHistory(move, timestamp) {
            const moveItem = document.createElement('div');
            moveItem.className = 'move-item';
            
            const time = new Date(timestamp).toLocaleTimeString();
            moveItem.innerHTML = `
                <span class="move-notation">${move}</span>
                <span class="move-time">${time}</span>
            `;
            
            // Remove placeholder text
            if (moveHistory.children.length === 1 && moveHistory.children[0].style.color === 'rgb(102, 102, 102)') {
                moveHistory.innerHTML = '';
            }
            
            moveHistory.insertBefore(moveItem, moveHistory.firstChild);
            
            // Keep only last 50 moves
            while (moveHistory.children.length > 50) {
                moveHistory.removeChild(moveHistory.lastChild);
            }
        }

        function updateMoveHistory(moves) {
            moveHistory.innerHTML = '';
            
            if (moves.length === 0) {
                moveHistory.innerHTML = '<div style="color: #666; text-align: center; padding: 20px; font-size: 0.8rem;">No moves recorded yet</div>';
                return;
            }
            
            moves.slice().reverse().forEach(move => {
                addMoveToHistory(move.move, move.timestamp);
            });
        }

        function updateOrientation(quaternion) {
            // ACTUALLY CALL THE FUCKING ROTATION FUNCTION
            update3DCubeOrientation(quaternion);
        }

        function updateOrientationDisplay(quaternion) {
            // Display raw quaternion values
            orientX.textContent = quaternion.x.toFixed(3);
            orientY.textContent = quaternion.y.toFixed(3);
            orientZ.textContent = quaternion.z.toFixed(3);
            orientW.textContent = quaternion.w.toFixed(3);
        }

        // 3D Cube orientation tracking
        let twistyScene = null;
        let cubeQuaternion = new THREE.Quaternion();
        let animationStarted = false;

        function initializeTwistyPlayer() {
            if (!twistyPlayer) return;
            
            // Keep trying to get the scene
            const tryInit = setInterval(() => {
                try {
                    // Try multiple ways to access the 3D scene
                    const player = document.querySelector('#twistyPlayer');
                    if (!player) return;
                    
                    // Method 1: Direct scene access
                    const scene = player.scene || 
                                 player.twisty3DCanvas?.scene ||
                                 player.twisty3DPuzzle?.world?.scene;
                    
                    if (scene) {
                        twistyScene = scene;
                        console.log('Got twisty scene directly');
                        clearInterval(tryInit);
                        if (!animationStarted) {
                            animationStarted = true;
                            animateCubeOrientation();
                        }
                        return;
                    }
                    
                    // Method 2: Via experimental model
                    if (twistyPlayer.experimentalModel?.twistySceneModel?.twistyScene) {
                        twistyScene = twistyPlayer.experimentalModel.twistySceneModel.twistyScene;
                        console.log('Got twisty scene via experimental model');
                        clearInterval(tryInit);
                        if (!animationStarted) {
                            animationStarted = true;
                            animateCubeOrientation();
                        }
                    }
                } catch (e) {
                    // Keep trying
                }
            }, 100);
            
            // Stop trying after 5 seconds
            setTimeout(() => clearInterval(tryInit), 5000);
        }

        function update3DCubeOrientation(quaternion) {
            if (!quaternion) return;
            
            let { x: qx, y: qy, z: qz, w: qw } = quaternion;
            
            // Apply the same axis mapping as the original simple-bridge.html
            let visualQuat = new THREE.Quaternion(
                -qx,  // cube x → -x (matches working visualization)
                qz,   // cube z → visual y (up)
                qy,   // cube y → visual z (forward)
                qw
            ).normalize();
            
            if (!basis) {
                const correction = new THREE.Quaternion().setFromEuler(
                    new THREE.Euler(0, 2*Math.PI, 0) // Same correction as original
                );
                
                basis = visualQuat.clone().multiply(correction).invert();
                console.log('Set orientation basis');
            }
            
            const relativeQuat = visualQuat.clone().multiply(basis);
            cubeQuaternion.copy(relativeQuat);
        }

        function resetCubeOrientation() {
            basis = null;
            console.log('Reset cube orientation');
        }

        function animateCubeOrientation() {
            if (twistyScene) {
                // Smoothly interpolate to target orientation
                twistyScene.quaternion.slerp(cubeQuaternion, 0.25);
            } else if (twistyPlayer && twistyPlayer.experimentalModel) {
                // Try to set orientation directly on the player
                try {
                    const scene = twistyPlayer.experimentalModel.twistySceneModel?.twistyScene;
                    if (scene) {
                        scene.quaternion.slerp(cubeQuaternion, 0.25);
                        twistyScene = scene; // Cache it for next time
                    }
                } catch (e) {
                    // Ignore
                }
            }
            
            requestAnimationFrame(animateCubeOrientation);
        }

        // Event listeners
        connectBtn.addEventListener('click', () => {
            socket.emit('connect_cube');
        });

        disconnectBtn.addEventListener('click', () => {
            socket.emit('disconnect_cube');
        });

        resetOrientationBtn.addEventListener('click', () => {
            resetCubeOrientation();
            socket.emit('reset_orientation');
            showMessage('Cube and controller orientation reset', 'success');
        });

        clearHistoryBtn.addEventListener('click', () => {
            socket.emit('clear_history');
            totalMoves = 0;
            moveCount.textContent = '0';
        });

        controllerToggle.addEventListener('click', () => {
            controllerEnabled = !controllerEnabled;
            controllerToggle.classList.toggle('active', controllerEnabled);
            socket.emit('enable_controller', { enable: controllerEnabled });
        });

        connectControllerBtn.addEventListener('click', () => {
            socket.emit('connect_controller_bridge');
        });

        // Initialize when twisty player loads
        setTimeout(initializeTwistyPlayer, 500);
        // Try again after page fully loads
        window.addEventListener('load', () => {
            setTimeout(initializeTwistyPlayer, 100);
        });
    </script>
</body>
</html>
